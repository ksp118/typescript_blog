name: Deploy TypeScript Blog to EC2

on:
  push:
    branches: [main]

env:
  NODE_VERSION: "20"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Node.js ì„¤ì •
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      # 3) ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          npm install
          npm install --workspace=server
          npm install --workspace=frontend

      # 4) í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      - name: Build frontend
        run: npm run build --workspace=frontend

      # 5) ì„œë²„ ë¹Œë“œ
      - name: Build server
        run: |
          npm run build --workspace=server
          cd server
          npm ci --omit=dev --ignore-scripts

      # 6) ë°°í¬ ë²ˆë“¤ ì¤€ë¹„
      - name: Prepare deployment bundle
        run: |
          # ì„œë²„ ë°°í¬ ì¤€ë¹„
          mkdir -p deploy/app
          cp -r server/dist deploy/app/
          cp -r server/node_modules deploy/app/
          cp server/package.json deploy/app/

          # í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì¤€ë¹„
          mkdir -p deploy/static
          cp -r frontend/dist/* deploy/static/

          # PM2 ì„¤ì • íŒŒì¼ (ê²½ë¡œ ìˆ˜ì •)
          cat > deploy/ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [
              {
                name: "blog-backend",
                script: "/home/ksp118/app/dist/server.js",
                cwd: "/home/ksp118/app",
                watch: false,
                exec_mode: "cluster",
                instances: "max",
                env: {
                  NODE_ENV: "production",
                },
                output: "/home/ksp118/logs/pm2/console.log",
                error: "/home/ksp118/logs/pm2/consoleError.log",
              },
            ],
          };
          EOF

      # 7) EC2ì— ë°°í¬
      - name: Deploy to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          source: "deploy/*"
          target: "/tmp/blog-deploy"
          strip_components: 1

      # 8) EC2ì—ì„œ ë°°í¬ ì™„ë£Œ
      - name: Finalize deployment on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e

            echo "ðŸš€ Starting deployment..."

            # ê¸°ì¡´ íŒŒì¼ ì •ë¦¬ ë° ìƒˆ íŒŒì¼ ë°°ì¹˜
            echo "ðŸ“ Cleaning up old files..."
            rm -rf /home/ksp118/app
            rm -rf /srv/blog/*

            echo "ðŸ“¦ Deploying new files..."
            mv /tmp/blog-deploy/app /home/ksp118/
            cp -r /tmp/blog-deploy/static/* /srv/blog/
            cp /tmp/blog-deploy/ecosystem.config.js /home/ksp118/

            # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -rf /tmp/blog-deploy

            echo "ðŸ”„ Restarting PM2..."
            # PM2 í”„ë¡œì„¸ìŠ¤ ìž¬ì‹œìž‘ (ì¡´ìž¬í•˜ì§€ ì•Šìœ¼ë©´ ì‹œìž‘)
            pm2 delete blog-backend 2>/dev/null || true
            pm2 start /home/ksp118/ecosystem.config.js
            pm2 save

            echo "âœ… Deployment completed successfully!"
            pm2 status
